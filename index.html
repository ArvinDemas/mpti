<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Mahasiswa - UPN "Veteran" Yogyakarta</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#15803d',       
                        primaryDark: '#14532d',   
                        primaryLight: '#dcfce7',  
                        accent: '#ca8a04',        
                        accentLight: '#fef9c3',   
                        secondary: '#64748B',     
                        bgInput: '#F3F4F6',
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* Table Styles */
        .table-header { @apply px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider bg-gray-50; }
        .table-cell { @apply px-6 py-4 whitespace-nowrap text-sm text-gray-700 border-b border-gray-100; }
        .badge { @apply px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full; }
        
        /* Loading Spinner */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #15803d; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800">

    <div id="login-container" class="min-h-screen flex items-center justify-center p-4 md:p-8 bg-slate-100">
        <div class="bg-white w-full max-w-6xl rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row min-h-[650px]">
            
            <div class="w-full md:w-1/2 p-8 md:p-16 flex flex-col justify-center relative">
                <div class="w-full max-w-md mx-auto">
                    
                    <div id="view-login" class="fade-in">
                        <div class="text-center mb-10">
                            <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">Portal Terintegrasi</h1>
                            <h2 class="text-lg font-semibold text-primary mb-3">UPN "Veteran" Yogyakarta</h2>
                            <div class="flex justify-center gap-2 text-[10px] font-bold tracking-widest uppercase text-slate-400">
                                <span>BIMA</span>â€¢<span>SPADA</span>â€¢<span>SADEWA</span>â€¢<span>NAKULA</span>
                            </div>
                        </div>

                        <form onsubmit="handleLogin(event)" class="space-y-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-600 mb-2">Username (NIM/NIK)</label>
                                <input type="text" id="login-username" value="124230001"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition text-gray-700 bg-bgInput"
                                    placeholder="Masukkan Username">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-600 mb-2">Password</label>
                                <input type="password" id="login-password" value="password"
                                    class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition text-gray-700 bg-bgInput"
                                    placeholder="Masukkan Password">
                            </div>
                            <button type="submit" id="btn-login"
                                class="w-full bg-primary hover:bg-primaryDark text-white font-bold text-lg py-3.5 rounded-lg shadow-lg shadow-green-200 transition duration-300 mt-4 flex items-center justify-center gap-2 group">
                                LOGIN <i data-lucide="arrow-right" class="w-5 h-5 group-hover:translate-x-1 transition"></i>
                            </button>
                        </form>

                        <div class="flex justify-between items-center mt-8 text-sm font-medium text-gray-500">
                            <button onclick="showToast('Info', 'Hubungi admin untuk aktivasi akun')" class="hover:text-primary transition">Aktivasi Akun</button>
                            <button onclick="showToast('Info', 'Hubungi admin untuk reset password')" class="hover:text-primary transition">Lupa Password?</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="hidden md:flex w-1/2 bg-gradient-to-br from-green-800 via-primary to-yellow-600 relative flex-col justify-center p-12 lg:p-20 text-white overflow-hidden">
                <div class="absolute inset-0 z-0">
                    <img src="https://images.unsplash.com/photo-1562774053-701939374585?q=80&w=1986&auto=format&fit=crop" alt="Kampus" class="w-full h-full object-cover opacity-30 mix-blend-multiply">
                </div>
                <div class="relative z-10 space-y-8">
                    <div>
                        <h1 class="text-4xl font-bold leading-tight tracking-tight mb-2 text-white">Selamat Datang di SEMAR</h1>
                        <h2 class="text-lg font-medium text-yellow-200 opacity-90">Single Entry Multi Access Resource</h2>
                    </div>
                    <div class="w-20 h-1.5 bg-yellow-400 rounded-full"></div>
                    <div class="space-y-4 text-sm leading-relaxed text-green-50 font-light opacity-90">
                        <p>Satu akun untuk mengakses seluruh layanan akademik dan kemahasiswaan Kampus Bela Negara.</p>
                        <div class="flex gap-3 mt-4">
                            <div class="bg-white/10 backdrop-blur-sm px-3 py-2 rounded border border-white/20">
                                <i data-lucide="shield-check" class="w-6 h-6 text-yellow-300 mb-1"></i>
                                <span class="text-xs font-semibold">Terintegrasi</span>
                            </div>
                            <div class="bg-white/10 backdrop-blur-sm px-3 py-2 rounded border border-white/20">
                                <i data-lucide="zap" class="w-6 h-6 text-yellow-300 mb-1"></i>
                                <span class="text-xs font-semibold">Cepat</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden flex h-screen overflow-hidden bg-gray-100">
        
        <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 text-gray-700 flex flex-col transition-all duration-300 transform translate-x-0 z-30 fixed md:relative h-full">
            <div class="p-6 bg-green-50 border-b border-green-100">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-green-900 rounded-full flex items-center justify-center text-white font-bold shadow-sm ring-2 ring-gray-200 ring-offset-2" id="avatar">U</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-bold truncate text-gray-900" id="sidebar-username">User</p>
                        <p class="text-xs text-primary font-medium" id="sidebar-role">ROLE</p>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 py-4 overflow-y-auto space-y-1 px-3" id="nav-links">
                </nav>

            <div class="p-4 border-t border-gray-200">
                <button onclick="handleLogout()" class="w-full bg-red-50 text-red-600 hover:bg-red-100 py-2.5 px-4 rounded-lg font-bold transition flex items-center justify-center gap-2 group">
                    <i data-lucide="log-out" class="w-4 h-4 group-hover:-translate-x-1 transition"></i> Keluar
                </button>
            </div>
        </aside>

        <div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
            
            <header class="md:hidden bg-white border-b p-4 flex justify-between items-center z-20 shadow-sm">
                <button onclick="toggleSidebar()" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg"><i data-lucide="menu" class="w-6 h-6"></i></button>
                <h1 class="font-bold text-lg text-primary tracking-tight">SEMAR MOBILE</h1>
                <div class="bg-green-100 p-2 rounded-full">
                    <i data-lucide="user" class="w-5 h-5 text-primary"></i>
                </div>
            </header>

            <main id="main-content" class="flex-1 overflow-y-auto bg-slate-50 p-4 md:p-8 relative scroll-smooth">
                </main>
        </div>

        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden backdrop-blur-sm transition-opacity"></div>
    </div>

    <div id="toast" class="fixed top-5 right-5 bg-white border-l-4 border-primary text-gray-800 px-6 py-4 rounded-lg shadow-2xl transform translate-x-full transition-transform duration-300 z-[60] flex items-center gap-4 min-w-[320px]">
        <div id="toast-icon" class="text-primary"><i data-lucide="check-circle" class="w-6 h-6"></i></div>
        <div>
            <h4 class="font-bold text-sm text-gray-900" id="toast-title">Notifikasi</h4>
            <p id="toast-msg" class="text-xs text-gray-500 mt-1">Pesan detail...</p>
        </div>
        <button onclick="hideToast()" class="ml-auto text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-4 h-4"></i></button>
    </div>

    <script>
        // Configuration
        const API_URL = 'api/'; // Base URL for PHP Backend
        
        // Global State
        const state = { 
            isLoggedIn: false, 
            currentUser: null, 
            dashboardData: null,
            currentPage: 'dashboard',
            isLoading: false
        };

        // ==========================================
        // AUTHENTICATION SYSTEM
        // ==========================================
        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-login');
            const originalText = btn.innerHTML;
            
            // Set Loading State
            btn.innerHTML = '<div class="loader mr-2"></div> Memproses...'; 
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            btn.disabled = true;

            const nim = document.getElementById('login-username').value.trim();
            const pass = document.getElementById('login-password').value;

            try {
                // Fetch to PHP Backend
                const response = await fetch(API_URL + 'login.php', { 
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: nim, password: pass})
                });

                // Parse Response
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (err) {
                    console.error("Invalid JSON:", text);
                    throw new Error("Respon server tidak valid.");
                }

                if (data.status === 'success') {
                    // Success Logic
                    state.currentUser = data.data;
                    state.isLoggedIn = true;
                    
                    // Initial Data Load
                    await loadDashboardData();
                    
                    // Switch UI
                    document.getElementById('login-container').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    
                    initSidebarAndHeader();
                    showToast('Login Berhasil', `Selamat datang kembali, ${state.currentUser.name}!`);
                } else {
                    // Failed Logic
                    showToast('Login Gagal', data.message || 'Username atau password salah', true);
                }
            } catch (err) { 
                console.error('Login Error:', err);
                showToast('Koneksi Error', 'Gagal terhubung ke server. Cek internet/server database.', true); 
            } finally { 
                // Reset Button
                btn.innerHTML = originalText; 
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
                btn.disabled = false; 
                lucide.createIcons();
            }
        }

        async function handleLogout() {
            if (confirm('Apakah Anda yakin ingin keluar dari sistem?')) {
                try {
                    await fetch(API_URL + 'logout.php');
                    state.isLoggedIn = false;
                    state.currentUser = null;
                    state.dashboardData = null;
                    
                    document.getElementById('app-container').classList.add('hidden');
                    document.getElementById('login-container').classList.remove('hidden');
                    document.getElementById('login-password').value = '';
                    showToast('Logout', 'Anda telah keluar dari sesi.');
                } catch (e) {
                    console.error("Logout Error", e);
                }
            }
        }

        // ==========================================
        // DATA MANAGEMENT
        // ==========================================
        async function loadDashboardData() {
            if (!state.currentUser) return;

            const role = state.currentUser.role;
            let endpoint = '';
            
            // Determine Endpoint based on Role
            if (role === 'mahasiswa') endpoint = 'get_dashboard_mhs.php';
            else if (role === 'dosen') endpoint = 'get_dashboard_dosen.php';
            else if (role === 'admin') endpoint = 'get_dashboard_admin.php';

            try {
                state.isLoading = true;
                const res = await fetch(API_URL + endpoint);
                const json = await res.json();

                if (json.status === 'success') {
                    state.dashboardData = json.data;
                } else {
                    showToast('Data Error', 'Gagal memuat data dashboard: ' + json.message, true);
                    // Initialize empty structure to prevent crashes
                    state.dashboardData = getEmptyDataStructure(role);
                }
            } catch (e) {
                console.error('Data Load Error:', e);
                showToast('Network Error', 'Gagal mengambil data dari server.', true);
                state.dashboardData = getEmptyDataStructure(role);
            } finally {
                state.isLoading = false;
            }
        }

        function getEmptyDataStructure(role) {
            if (role === 'mahasiswa') return { schedule: [], tasks: [], appeals: [] };
            if (role === 'dosen') return { courses: [], logs: [], tasks: [] };
            if (role === 'admin') return { appeals: [], users: [] };
            return {};
        }

        // ==========================================
        // UI RENDERING ENGINE
        // ==========================================
        function initSidebarAndHeader() {
            // Set User Info in Sidebar
            document.getElementById('sidebar-username').innerText = state.currentUser.name;
            document.getElementById('sidebar-role').innerText = state.currentUser.role.toUpperCase();
            document.getElementById('avatar').innerText = state.currentUser.name.charAt(0).toUpperCase();
            
            // Generate Sidebar Links
            renderSidebarLinks();
            
            // Render Initial Page
            navigateTo('dashboard');
        }

        function renderSidebarLinks() {
            const role = state.currentUser.role;
            let items = [];

            if (role === 'mahasiswa') {
                items = [
                    { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
                    { id: 'jadwal', label: 'Jadwal & Presensi', icon: 'calendar-check' },
                    { id: 'tugas', label: 'Tugas Kuliah', icon: 'book-open' },
                    { id: 'ukt', label: 'Layanan Keuangan', icon: 'wallet' },
                ];
            } else if (role === 'dosen') {
                items = [
                    { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
                    { id: 'kelas', label: 'Kelas Ajar', icon: 'users' },
                    { id: 'presensi', label: 'Log Kehadiran', icon: 'clipboard-list' },
                    { id: 'tugas_dosen', label: 'Manajemen Tugas', icon: 'file-plus' },
                ];
            } else if (role === 'admin') {
                items = [
                    { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
                    { id: 'sanggah', label: 'Verifikasi UKT', icon: 'file-check' },
                    { id: 'users', label: 'Data Pengguna', icon: 'user-cog' },
                ];
            }

            const html = items.map(item => {
                const isActive = state.currentPage === item.id;
                const activeClass = isActive ? 'bg-green-50 text-primary border-r-4 border-primary font-bold' : 'text-gray-600 hover:bg-gray-50 hover:text-primary';
                
                return `
                <button onclick="navigateTo('${item.id}')" class="w-full flex items-center gap-3 px-4 py-3 text-sm transition-all duration-200 ${activeClass}">
                    <i data-lucide="${item.icon}" class="w-5 h-5"></i>
                    <span>${item.label}</span>
                </button>`;
            }).join('');

            document.getElementById('nav-links').innerHTML = html;
            lucide.createIcons();
        }

        function navigateTo(pageId) {
            state.currentPage = pageId;
            renderSidebarLinks(); // Re-render sidebar to update active state
            
            const content = document.getElementById('main-content');
            
            // Show Loading Indicator
            content.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full min-h-[400px]">
                    <div class="loader mb-4" style="width: 40px; height: 40px; border-width: 4px;"></div>
                    <p class="text-gray-500 font-medium">Memuat Halaman...</p>
                </div>`;
            
            // Simulate slight delay for smoothness (optional) & Render
            setTimeout(() => {
                const role = state.currentUser.role;
                if (role === 'mahasiswa') renderMahasiswaPages(pageId);
                else if (role === 'dosen') renderDosenPages(pageId);
                else if (role === 'admin') renderAdminPages(pageId);
                
                lucide.createIcons();
                
                // Auto close sidebar on mobile
                if (window.innerWidth < 768) {
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('sidebar-overlay');
                    if (!sidebar.classList.contains('-translate-x-full')) {
                        sidebar.classList.add('-translate-x-full');
                        overlay.classList.add('hidden');
                    }
                }
            }, 150);
        }

        // ==========================================
        // MAHASISWA PAGES RENDERER
        // ==========================================
        function renderMahasiswaPages(page) {
            const content = document.getElementById('main-content');
            const data = state.dashboardData || { schedule: [], tasks: [], appeals: [] };

            if (page === 'dashboard') {
                content.innerHTML = `
                    <div class="max-w-6xl mx-auto space-y-6 fade-in">
                        <div class="bg-gradient-to-r from-green-700 to-green-900 rounded-2xl p-8 text-white shadow-xl relative overflow-hidden">
                            <div class="absolute right-0 top-0 w-64 h-64 bg-yellow-400 rounded-full mix-blend-overlay filter blur-3xl opacity-20 transform translate-x-1/2 -translate-y-1/2"></div>
                            <div class="relative z-10">
                                <h2 class="text-3xl font-bold mb-1">Halo, ${state.currentUser.name.split(' ')[0]}! ðŸ‘‹</h2>
                                <p class="opacity-90 text-green-100 text-sm mb-6">${state.currentUser.major} â€¢ ${state.currentUser.username}</p>
                                
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="bg-white/10 p-4 rounded-xl backdrop-blur-md border border-white/10">
                                        <p class="text-xs text-green-200 uppercase tracking-wider mb-1">IPK Semester</p>
                                        <p class="text-2xl font-bold tracking-tight">3.85</p>
                                    </div>
                                    <div class="bg-white/10 p-4 rounded-xl backdrop-blur-md border border-white/10">
                                        <p class="text-xs text-green-200 uppercase tracking-wider mb-1">Total SKS</p>
                                        <p class="text-2xl font-bold tracking-tight">88</p>
                                    </div>
                                    <div class="bg-white/10 p-4 rounded-xl backdrop-blur-md border border-white/10">
                                        <p class="text-xs text-green-200 uppercase tracking-wider mb-1">Semester</p>
                                        <p class="text-2xl font-bold tracking-tight">5</p>
                                    </div>
                                    <div class="bg-white/10 p-4 rounded-xl backdrop-blur-md border border-white/10">
                                        <p class="text-xs text-green-200 uppercase tracking-wider mb-1">Status</p>
                                        <p class="text-lg font-bold tracking-tight text-green-300">Aktif</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                                        <div class="p-2 bg-green-100 rounded-lg text-primary"><i data-lucide="calendar" class="w-5 h-5"></i></div>
                                        Jadwal Hari Ini
                                    </h3>
                                    <button onclick="navigateTo('jadwal')" class="text-xs font-bold text-primary hover:underline">Lihat Semua</button>
                                </div>
                                ${renderScheduleList(data.schedule.slice(0, 3))}
                            </div>

                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                                        <div class="p-2 bg-yellow-100 rounded-lg text-yellow-600"><i data-lucide="bell" class="w-5 h-5"></i></div>
                                        Tugas Terbaru
                                    </h3>
                                    <button onclick="navigateTo('tugas')" class="text-xs font-bold text-primary hover:underline">Lihat Semua</button>
                                </div>
                                ${renderTaskList(data.tasks.slice(0, 3))}
                            </div>
                        </div>
                    </div>`;
            } 
            else if (page === 'jadwal') {
                content.innerHTML = `
                    <div class="max-w-4xl mx-auto fade-in">
                        <div class="flex justify-between items-end mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900">Jadwal Perkuliahan</h2>
                                <p class="text-gray-500 text-sm">Kelola kehadiran dan lihat jadwal kelas Anda.</p>
                            </div>
                            <span class="bg-green-100 text-primary px-3 py-1 rounded-full text-xs font-bold">Semester Ganjil 2024/2025</span>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            ${renderScheduleList(data.schedule, true)}
                        </div>
                    </div>`;
            }
            else if (page === 'tugas') {
                content.innerHTML = `
                    <div class="max-w-4xl mx-auto fade-in">
                        <div class="mb-6">
                            <h2 class="text-2xl font-bold text-gray-900">Tugas & Assignment</h2>
                            <p class="text-gray-500 text-sm">Upload tugas sebelum tenggat waktu berakhir.</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            ${renderTaskList(data.tasks, true)}
                        </div>
                    </div>`;
            }
            else if (page === 'ukt') {
                content.innerHTML = `
                    <div class="max-w-4xl mx-auto fade-in">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Layanan Keuangan (UKT)</h2>
                        
                        <div class="grid md:grid-cols-3 gap-6 mb-8">
                            <div class="col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                <h3 class="font-bold text-lg mb-4 text-gray-800">Ajukan Sanggah Banding UKT</h3>
                                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                                    <p class="text-sm text-yellow-700">Pastikan Anda memiliki alasan yang kuat dan bukti pendukung sebelum mengajukan sanggahan.</p>
                                </div>
                                <div class="flex flex-col gap-3">
                                    <textarea id="ukt-alasan" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition" placeholder="Tuliskan alasan lengkap pengajuan sanggahan Anda di sini..."></textarea>
                                    <button onclick="performAction('sanggah_ukt')" class="self-end bg-primary text-white px-6 py-2.5 rounded-lg font-bold hover:bg-primaryDark transition shadow-lg shadow-green-100 flex items-center gap-2">
                                        <i data-lucide="send" class="w-4 h-4"></i> Kirim Pengajuan
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-blue-50 rounded-xl p-6 border border-blue-100">
                                <h3 class="font-bold text-blue-900 mb-2">Tagihan Anda</h3>
                                <p class="text-sm text-blue-700 mb-4">UKT Golongan V</p>
                                <p class="text-3xl font-bold text-blue-900 mb-2">Rp 4.500.000</p>
                                <span class="bg-green-200 text-green-800 px-2 py-1 rounded text-xs font-bold">LUNAS</span>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                                <h3 class="font-bold text-gray-700">Riwayat Pengajuan</h3>
                            </div>
                            <div class="p-6">
                                ${renderAppealHistory(data.appeals)}
                            </div>
                        </div>
                    </div>`;
            }
        }

        // ==========================================
        // DOSEN PAGES RENDERER
        // ==========================================
        function renderDosenPages(page) {
            const content = document.getElementById('main-content');
            const data = state.dashboardData || { courses: [], logs: [], tasks: [] };

            if (page === 'dashboard') {
                content.innerHTML = `
                    <div class="max-w-6xl mx-auto space-y-6 fade-in">
                        <div class="bg-gradient-to-r from-blue-700 to-indigo-900 rounded-2xl p-8 text-white shadow-xl">
                            <h2 class="text-3xl font-bold mb-2">Selamat Datang, Dosen!</h2>
                            <p class="opacity-90 text-blue-100">${state.currentUser.name} â€¢ NIP. ${state.currentUser.username}</p>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                                    <i data-lucide="calendar" class="w-5 h-5 text-blue-600"></i> Kelas Hari Ini
                                </h3>
                                ${renderClassList(data.courses.slice(0, 3))}
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                                    <i data-lucide="clock" class="w-5 h-5 text-green-600"></i> Aktivitas Presensi Terkini
                                </h3>
                                ${renderPresenceLogCompact(data.logs.slice(0, 5))}
                            </div>
                        </div>
                    </div>`;
            }
            else if (page === 'kelas') {
                content.innerHTML = `
                    <div class="max-w-5xl mx-auto fade-in">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Daftar Kelas Ajar</h2>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            ${renderClassList(data.courses, true)}
                        </div>
                    </div>`;
            }
            else if (page === 'presensi') {
                content.innerHTML = `
                    <div class="max-w-6xl mx-auto fade-in">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Rekapitulasi Kehadiran</h2>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="table-header">Mahasiswa</th>
                                            <th class="table-header">Mata Kuliah</th>
                                            <th class="table-header">Waktu Presensi</th>
                                            <th class="table-header">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${renderPresenceLogTable(data.logs)}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
            }
            else if (page === 'tugas_dosen') {
                content.innerHTML = `
                     <div class="max-w-5xl mx-auto fade-in">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Manajemen Tugas</h2>
                        
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
                            <h3 class="font-bold text-lg mb-4 text-gray-800">Buat Tugas Baru</h3>
                            <div class="grid md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mata Kuliah</label>
                                    <select id="task-course" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary">
                                        <option value="">-- Pilih Mata Kuliah --</option>
                                        ${(data.courses || []).map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tenggat Waktu</label>
                                    <input type="datetime-local" id="task-deadline" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary">
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Judul Tugas</label>
                                <input type="text" id="task-title" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary" placeholder="Contoh: Laporan Praktikum Modul 1">
                            </div>
                            <button onclick="performAction('create_task')" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition w-full md:w-auto">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> Publikasikan Tugas
                            </button>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            <h3 class="font-bold text-lg mb-4 text-gray-800">Daftar Tugas Aktif</h3>
                             ${renderDosenTaskList(data.tasks || [])}
                        </div>
                     </div>`;
            }
        }

        // ==========================================
        // ADMIN PAGES RENDERER
        // ==========================================
        function renderAdminPages(page) {
            const content = document.getElementById('main-content');
            const data = state.dashboardData || { appeals: [], users: [] };

            if (page === 'dashboard') {
                const waitingCount = data.appeals.filter(a => a.status === 'Menunggu').length;
                const approvedCount = data.appeals.filter(a => a.status === 'Disetujui').length;

                content.innerHTML = `
                    <div class="max-w-6xl mx-auto space-y-6 fade-in">
                        <div class="bg-gradient-to-r from-purple-700 to-indigo-900 rounded-2xl p-8 text-white shadow-xl">
                            <h2 class="text-3xl font-bold mb-2">Panel Admin</h2>
                            <p class="opacity-90">Sistem Informasi Akademik Terpadu</p>
                        </div>

                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col items-center justify-center">
                                <div class="bg-blue-100 p-3 rounded-full mb-3"><i data-lucide="users" class="w-6 h-6 text-blue-600"></i></div>
                                <span class="text-3xl font-bold text-gray-800">1,240</span>
                                <span class="text-sm text-gray-500">Total User Aktif</span>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col items-center justify-center">
                                <div class="bg-yellow-100 p-3 rounded-full mb-3"><i data-lucide="alert-circle" class="w-6 h-6 text-yellow-600"></i></div>
                                <span class="text-3xl font-bold text-gray-800">${waitingCount}</span>
                                <span class="text-sm text-gray-500">Menunggu Verifikasi</span>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col items-center justify-center">
                                <div class="bg-green-100 p-3 rounded-full mb-3"><i data-lucide="check-square" class="w-6 h-6 text-green-600"></i></div>
                                <span class="text-3xl font-bold text-gray-800">${approvedCount}</span>
                                <span class="text-sm text-gray-500">Sanggahan Disetujui</span>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                                <h3 class="font-bold text-gray-700">Antrean Sanggah UKT</h3>
                                <button onclick="navigateTo('sanggah')" class="text-sm text-purple-600 font-bold hover:underline">Lihat Semua</button>
                            </div>
                            ${renderAppealTable(data.appeals.slice(0, 5), true)}
                        </div>
                    </div>`;
            }
            else if (page === 'sanggah') {
                content.innerHTML = `
                    <div class="max-w-6xl mx-auto fade-in">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Manajemen Sanggah UKT</h2>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                             ${renderAppealTable(data.appeals, true)}
                        </div>
                    </div>`;
            }
            else if (page === 'users') {
                content.innerHTML = `
                    <div class="max-w-6xl mx-auto fade-in">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">Data Pengguna</h2>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col items-center justify-center py-12">
                            <i data-lucide="database" class="w-16 h-16 text-gray-300 mb-4"></i>
                            <h3 class="text-lg font-bold text-gray-600">Fitur dalam pengembangan</h3>
                            <p class="text-gray-400">Modul manajemen user akan segera tersedia.</p>
                        </div>
                    </div>`;
            }
        }

        // ==========================================
        // COMPONENT RENDERERS (HELPERS)
        // ==========================================
        
        // --- Mahasiswa Components ---
        function renderScheduleList(schedule, showAll = false) {
            if (!schedule || schedule.length === 0) {
                return `<div class="text-center py-8 text-gray-400 bg-gray-50 rounded-lg border border-dashed border-gray-200">
                    <i data-lucide="calendar-off" class="w-8 h-8 mx-auto mb-2"></i>
                    <p class="text-sm">Tidak ada jadwal kuliah.</p>
                </div>`;
            }

            return `<div class="space-y-4">
                ${schedule.map(c => {
                    const isPresent = parseInt(c.is_present) > 0;
                    const cardClass = "border border-gray-200 rounded-xl p-4 transition hover:shadow-md hover:border-primary/30 bg-white";
                    
                    let buttonHtml = '';
                    if (isPresent) {
                        buttonHtml = `
                        <button disabled class="w-full mt-3 py-2 bg-green-50 text-green-700 rounded-lg text-sm font-bold flex items-center justify-center gap-2 cursor-not-allowed border border-green-100">
                            <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                            Hadir (${c.present_time || 'Tercatat'})
                        </button>`;
                    } else {
                        buttonHtml = `
                        <button onclick="performAction('presensi', ${c.id})" class="w-full mt-3 py-2 bg-primary text-white rounded-lg text-sm font-bold flex items-center justify-center gap-2 hover:bg-primaryDark transition shadow-sm">
                            <i data-lucide="fingerprint" class="w-4 h-4"></i>
                            Rekam Kehadiran
                        </button>`;
                    }

                    return `
                    <div class="${cardClass}">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-gray-800 text-lg">${c.name}</h4>
                                <div class="flex items-center gap-2 text-xs text-gray-500 mt-1">
                                    <span class="bg-gray-100 px-2 py-0.5 rounded text-gray-600 font-mono">${c.code}</span>
                                    <span>â€¢</span>
                                    <span>${c.sks} SKS</span>
                                </div>
                            </div>
                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold shadow-sm whitespace-nowrap">
                                ${c.time_start} - ${c.time_end}
                            </span>
                        </div>
                        <div class="flex items-center gap-4 text-sm text-gray-600 mt-3 bg-gray-50 p-2 rounded-lg">
                            <div class="flex items-center gap-1.5">
                                <i data-lucide="map-pin" class="w-4 h-4 text-accent"></i>
                                <span class="font-medium">${c.room}</span>
                            </div>
                            <div class="h-4 w-px bg-gray-300"></div>
                            <div class="flex items-center gap-1.5">
                                <i data-lucide="user" class="w-4 h-4 text-gray-400"></i>
                                <span class="truncate max-w-[150px]">Dosen Pengampu</span>
                            </div>
                        </div>
                        ${buttonHtml}
                    </div>`;
                }).join('')}
            </div>`;
        }

        function renderTaskList(tasks, showAll = false) {
            if (!tasks || tasks.length === 0) {
                return `<div class="text-center py-8 text-gray-400 bg-gray-50 rounded-lg border border-dashed border-gray-200">
                    <i data-lucide="check-square" class="w-8 h-8 mx-auto mb-2"></i>
                    <p class="text-sm">Tidak ada tugas aktif.</p>
                </div>`;
            }

            return `<div class="space-y-4">
                ${tasks.map(t => {
                    const isSubmitted = t.submitted_at != null;
                    const deadlineDate = new Date(t.deadline);
                    const isOverdue = new Date() > deadlineDate;
                    
                    const statusConfig = isSubmitted 
                        ? { color: 'green', text: 'Terkirim', icon: 'check-circle' }
                        : isOverdue 
                            ? { color: 'red', text: 'Terlambat', icon: 'alert-circle' }
                            : { color: 'yellow', text: 'Belum Kumpul', icon: 'clock' };

                    return `
                    <div class="border border-gray-200 rounded-xl p-4 bg-white hover:border-blue-300 transition relative overflow-hidden group">
                        ${isOverdue && !isSubmitted ? '<div class="absolute left-0 top-0 bottom-0 w-1 bg-red-500"></div>' : ''}
                        
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-gray-800">${t.title}</h4>
                            <span class="px-2 py-1 rounded-md text-xs font-bold flex items-center gap-1 bg-${statusConfig.color}-100 text-${statusConfig.color}-700">
                                <i data-lucide="${statusConfig.icon}" class="w-3 h-3"></i> ${statusConfig.text}
                            </span>
                        </div>
                        
                        <p class="text-xs text-gray-500 mb-3 uppercase tracking-wide font-semibold">${t.course_name || 'Mata Kuliah Umum'}</p>
                        
                        <div class="flex items-center gap-2 text-sm text-gray-600 mb-4">
                            <i data-lucide="calendar" class="w-4 h-4 text-gray-400"></i>
                            <span>Deadline: <span class="font-medium ${isOverdue ? 'text-red-600' : ''}">${deadlineDate.toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}</span></span>
                        </div>

                        ${!isSubmitted ? `
                        <form onsubmit="performUpload(event, ${t.id})" class="flex gap-2">
                            <label class="flex-1 cursor-pointer">
                                <div class="w-full border border-dashed border-gray-300 rounded-lg px-3 py-2 text-xs text-gray-500 flex items-center justify-center hover:bg-gray-50 transition h-full">
                                    <span class="file-name-placeholder">Pilih File...</span>
                                    <input type="file" required class="hidden" onchange="this.parentElement.querySelector('.file-name-placeholder').innerText = this.files[0].name">
                                </div>
                            </label>
                            <button type="submit" class="bg-blue-600 text-white px-4 rounded-lg text-sm font-bold hover:bg-blue-700 transition shadow-sm">
                                Upload
                            </button>
                        </form>
                        ` : `
                        <div class="bg-green-50 text-green-700 text-xs p-2 rounded border border-green-100 flex items-center gap-2">
                            <i data-lucide="file-check" class="w-4 h-4"></i>
                            File berhasil diunggah pada ${new Date(t.submitted_at).toLocaleDateString('id-ID')}
                        </div>
                        `}
                    </div>`;
                }).join('')}
            </div>`;
        }

        function renderAppealHistory(appeals) {
            if (!appeals || appeals.length === 0) return '<p class="text-gray-500 text-sm italic">Belum ada riwayat pengajuan.</p>';
            
            return `<div class="space-y-0 divide-y divide-gray-100">
                ${appeals.map(a => {
                    let statusBadge = '';
                    if (a.status === 'Disetujui') statusBadge = '<span class="badge bg-green-100 text-green-800">Disetujui</span>';
                    else if (a.status === 'Ditolak') statusBadge = '<span class="badge bg-red-100 text-red-800">Ditolak</span>';
                    else statusBadge = '<span class="badge bg-yellow-100 text-yellow-800">Menunggu</span>';

                    return `
                    <div class="py-4 hover:bg-gray-50 transition px-2 -mx-2 rounded">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-xs text-gray-400 font-mono">${a.request_date}</span>
                            ${statusBadge}
                        </div>
                        <p class="text-gray-800 text-sm font-medium line-clamp-2">${a.description}</p>
                    </div>`;
                }).join('')}
            </div>`;
        }

        // --- Dosen Components ---
        function renderClassList(courses, detailed = false) {
            if (!courses || courses.length === 0) return '<div class="text-gray-500 text-center py-4 bg-gray-50 rounded-lg">Tidak ada jadwal kelas.</div>';
            
            return `<div class="grid gap-4 ${detailed ? 'md:grid-cols-2' : ''}">
                ${courses.map(c => `
                <div class="bg-white border border-gray-200 rounded-xl p-5 hover:shadow-md transition hover:border-blue-400 group relative">
                    <div class="flex justify-between items-start mb-3">
                        <div class="bg-blue-50 text-blue-700 p-2 rounded-lg group-hover:bg-blue-600 group-hover:text-white transition">
                            <i data-lucide="book" class="w-6 h-6"></i>
                        </div>
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">${c.code}</span>
                    </div>
                    <h4 class="font-bold text-gray-800 text-lg mb-1">${c.name}</h4>
                    <p class="text-sm text-gray-500 mb-4">Semester ${c.semester} â€¢ ${c.sks} SKS</p>
                    
                    <div class="flex items-center gap-4 text-sm text-gray-600 border-t border-gray-100 pt-3">
                        <div class="flex items-center gap-1.5">
                            <i data-lucide="clock" class="w-4 h-4 text-primary"></i>
                            <span class="font-medium">${c.time_start} - ${c.time_end}</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <i data-lucide="map-pin" class="w-4 h-4 text-accent"></i>
                            <span>${c.room}</span>
                        </div>
                    </div>
                    ${detailed ? '<div class="mt-4 pt-2"><button class="w-full py-2 border border-blue-600 text-blue-600 rounded-lg text-sm font-bold hover:bg-blue-50">Lihat Peserta</button></div>' : ''}
                </div>`).join('')}
            </div>`;
        }

        function renderPresenceLogCompact(logs) {
            if (!logs || logs.length === 0) return '<p class="text-gray-500 text-sm">Belum ada aktivitas.</p>';
            return `<div class="space-y-3">
                ${logs.map(l => `
                <div class="flex items-center justify-between border-b border-gray-50 pb-2 last:border-0">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-600">
                            ${l.mhs_name.charAt(0)}
                        </div>
                        <div>
                            <p class="text-sm font-bold text-gray-800">${l.mhs_name}</p>
                            <p class="text-xs text-gray-500 truncate max-w-[150px]">${l.course_name}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-xs font-bold text-green-600 block">${l.timestamp}</span>
                        <span class="text-[10px] text-gray-400">${l.status}</span>
                    </div>
                </div>`).join('')}
            </div>`;
        }

        function renderPresenceLogTable(logs) {
            if (!logs || logs.length === 0) return '<tr><td colspan="4" class="p-8 text-center text-gray-500">Data Kosong</td></tr>';
            return logs.map(l => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="table-cell font-medium text-gray-900">${l.mhs_name}</td>
                    <td class="table-cell">${l.course_name}</td>
                    <td class="table-cell text-gray-500 font-mono text-xs">${l.date} <span class="text-gray-900 font-bold">${l.timestamp}</span></td>
                    <td class="table-cell">
                        <span class="badge ${l.status === 'Hadir' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${l.status}
                        </span>
                    </td>
                </tr>`).join('');
        }

        function renderDosenTaskList(tasks) {
            if(!tasks || tasks.length === 0) return '<p class="text-gray-500 text-center py-4 italic">Belum ada tugas yang dibuat.</p>';
            return tasks.map(t => `
                <div class="flex justify-between items-center border-b border-gray-100 py-3 last:border-0">
                    <div>
                        <p class="font-bold text-gray-800">${t.title}</p>
                        <p class="text-xs text-gray-500">${t.course_name} â€¢ Deadline: ${t.deadline}</p>
                    </div>
                    <button class="text-xs text-red-500 hover:text-red-700 font-bold">Hapus</button>
                </div>
            `).join('');
        }

        // --- Admin Components ---
        function renderAppealTable(appeals, showActions) {
            if (!appeals || appeals.length === 0) return '<div class="p-8 text-center text-gray-500 bg-gray-50">Tidak ada data pengajuan.</div>';
            
            return `<table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="table-header">Mahasiswa</th>
                        <th class="table-header">Keterangan</th>
                        <th class="table-header">Status</th>
                        ${showActions ? '<th class="table-header text-right">Aksi</th>' : ''}
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${appeals.map(a => `
                    <tr>
                        <td class="table-cell">
                            <div class="flex flex-col">
                                <span class="font-bold text-gray-900">${a.name}</span>
                                <span class="text-xs text-gray-500">${a.nim}</span>
                            </div>
                        </td>
                        <td class="table-cell">
                            <p class="truncate max-w-xs" title="${a.description}">${a.description}</p>
                            <span class="text-xs text-gray-400">${a.request_date}</span>
                        </td>
                        <td class="table-cell">
                            <span class="badge ${a.status === 'Menunggu' ? 'bg-yellow-100 text-yellow-800' : a.status === 'Disetujui' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${a.status}
                            </span>
                        </td>
                        ${showActions ? `
                        <td class="table-cell text-right">
                            ${a.status === 'Menunggu' ? `
                            <div class="flex justify-end gap-2">
                                <button onclick="performAction('approve_appeal', ${a.id}, 'Disetujui')" class="p-1.5 bg-green-100 text-green-600 rounded hover:bg-green-200" title="Terima">
                                    <i data-lucide="check" class="w-4 h-4"></i>
                                </button>
                                <button onclick="performAction('approve_appeal', ${a.id}, 'Ditolak')" class="p-1.5 bg-red-100 text-red-600 rounded hover:bg-red-200" title="Tolak">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>` : '<span class="text-xs text-gray-400 italic">Selesai</span>'}
                        </td>` : ''}
                    </tr>`).join('')}
                </tbody>
            </table>`;
        }

        // ==========================================
        // ACTION HANDLERS
        // ==========================================
        async function performAction(actionType, id = null, extraData = null) {
            // Confirm sensitive actions
            if (actionType === 'approve_appeal' && !confirm(`Ubah status menjadi ${extraData}?`)) return;

            // Prepare Payload
            const formData = new FormData();
            formData.append('action', actionType);
            if (id) formData.append('id', id);

            if (actionType === 'sanggah_ukt') {
                const reason = document.getElementById('ukt-alasan').value.trim();
                if (!reason) return showToast('Error', 'Mohon isi alasan sanggahan.', true);
                formData.append('desc', reason);
            }
            else if (actionType === 'approve_appeal') {
                formData.append('status', extraData);
            }
            else if (actionType === 'presensi') {
                formData.append('course_id', id);
            }
            else if (actionType === 'create_task') {
                const courseId = document.getElementById('task-course').value;
                const title = document.getElementById('task-title').value;
                const deadline = document.getElementById('task-deadline').value;

                if(!courseId || !title || !deadline) return showToast('Validasi', 'Mohon lengkapi semua field', true);

                formData.append('course_id', courseId);
                formData.append('title', title);
                formData.append('deadline', deadline);
            }

            // Determine Endpoint
            let endpoint = 'action_mhs.php'; // Default
            if (['approve_appeal'].includes(actionType)) endpoint = 'action_admin.php';
            if (['create_task'].includes(actionType)) endpoint = 'action_dosen.php';

            try {
                const btnLoading = document.activeElement;
                if(btnLoading) {
                    btnLoading.disabled = true; 
                    btnLoading.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>';
                    lucide.createIcons();
                }

                const res = await fetch(API_URL + endpoint, { method: 'POST', body: formData });
                const json = await res.json();

                if (json.status === 'success') {
                    showToast('Berhasil', json.message);
                    
                    // Clear Forms if needed
                    if(actionType === 'sanggah_ukt') document.getElementById('ukt-alasan').value = '';
                    if(actionType === 'create_task') {
                        document.getElementById('task-title').value = '';
                        document.getElementById('task-deadline').value = '';
                    }

                    // Refresh Data
                    await loadDashboardData();
                    // Re-render current page
                    navigateTo(state.currentPage);
                } else {
                    showToast('Gagal', json.message, true);
                    if(btnLoading) { btnLoading.disabled = false; btnLoading.innerText = 'Coba Lagi'; }
                }
            } catch (e) {
                console.error(e);
                showToast('Error', 'Terjadi kesalahan sistem.', true);
            }
        }

        async function performUpload(e, taskId) {
            e.preventDefault();
            const fileInput = e.target.querySelector('input[type="file"]');
            const file = fileInput.files[0];
            
            if (!file) return showToast('Error', 'Pilih file terlebih dahulu!', true);

            const formData = new FormData();
            formData.append('action', 'upload_tugas');
            formData.append('assignment_id', taskId);
            formData.append('file', file);

            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerHTML = 'Uploading...';
            btn.disabled = true;

            try {
                const res = await fetch(API_URL + 'action_mhs.php', { method: 'POST', body: formData });
                const json = await res.json();

                if (json.status === 'success') {
                    showToast('Upload Berhasil', json.message);
                    await loadDashboardData();
                    navigateTo(state.currentPage);
                } else {
                    showToast('Upload Gagal', json.message, true);
                }
            } catch (e) {
                console.error(e);
                showToast('Error', 'Gagal mengunggah file.', true);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // ==========================================
        // UTILITIES
        // ==========================================
        let toastTimeout;
        function showToast(title, msg, isError = false) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-title').innerText = title;
            document.getElementById('toast-msg').innerText = msg;
            
            // Icon Styling
            const iconContainer = document.getElementById('toast-icon');
            iconContainer.className = isError ? 'text-red-500' : 'text-primary';
            iconContainer.innerHTML = isError 
                ? '<i data-lucide="alert-circle" class="w-6 h-6"></i>' 
                : '<i data-lucide="check-circle" class="w-6 h-6"></i>';
            
            // Border Styling
            toast.className = `fixed top-5 right-5 bg-white border-l-4 px-6 py-4 rounded-lg shadow-2xl transform transition-transform duration-300 z-[60] flex items-center gap-4 min-w-[320px] translate-x-0 ${isError ? 'border-red-500' : 'border-primary'}`;
            
            lucide.createIcons();
            
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(hideToast, 4000);
        }

        function hideToast() {
            document.getElementById('toast').classList.add('translate-x-full');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        // Initial Load
        lucide.createIcons();
    </script>
</body>
</html>